<div class="container">
  
  <div class="masthead"> 
    <h3 class="muted">Project name</h3>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <ul class="nav">
            <li><a href="./">Home</a></li>
            <li><a href="#">Projects</a></li>
            <li><a href="#">Services</a></li>
            <li><a href="#">Downloads</a></li>
            <li><a href="#">About</a></li>
            <li><a href="#">Contact</a></li>
          </ul>
        </div>
      </div>
    </div><!-- /.navbar -->
  </div>
  <div class="row">
    <div class="span8" style="background-color:#f4f4f4; position:relative; font-size: 9pt; color: #777777;">
      <canvas id="cv" style="padding:0" width="620" height="600" ></canvas>
      <div id="tip" style="display:block; color:#000000; padding:2px; position:absolute; left:10px; bottom:20px; background-color:#c0c0c0; height:50px; border-radius:5px; border:1px solid #000000; font-family:Arial,sans-serif; opacity:0.5;"> 
        Drag mouse to rotate <br> Drag mouse with shift pressed to zoom
      </div>
    </div>
    <div class="span4" style="position:relative; background-color:#f4f4f4; height:600px">
      <center><b>Title</b></center>
      <center><h4><%= @product.title %></h4></center>
      <center><%= image_tag @product.photo.url, id: "show_img", style: "margin:10px" %></center>
      
      <center><%= link_to "Model Download", "/stl_files/"+(@product.id).to_s+".stl", class: "btn btn-info btn-large", style: "width:230px;", download: @product.title+".stl" %></center><br>
      <div style="margin-left:10px; margin-top:50px;">
        Model Color:<input id="mdlClr" style="margin-right: 50px;" type="color" value="#00ff00" onchange="changeOption('ModelColor',this.value)"></input><br>
        Back Color1:<input id="bckClr1" style="margin-right: 50px;" type="color" onchange="changeOption('BackgroundColor1',this.value)"></input><br>
        Back Color2:<input id="bckClr2" type="color" onchange="changeOption('BackgroundColor2',this.value)"></input><br />
        Definition:
        <select id="defini" onchange="changeOption('Definition',this.value)">
          <option>Standard</option>
          <option>low</option>
          <option>high</option>
      </select>
      </div>
    </div>
  </div>
    This web application do not support the InternetExplorer.

      <hr>

      <div class="footer"><p>&copy; Company 2013</p></div>

</div>

<script type="text/javascript">
    var viewer3d;
    function getOptions(){
        var mc = document.getElementById("mdlClr").value;
        var bc1 = document.getElementById("bckClr1").value;
        var bc2 = document.getElementById("bckClr2").value;
        var ren = 'Flat';
        var def = document.getElementById("defini").value;
        return {ModelColor: mc,
                BackgroundColor1: bc1,
                BackgroundColor2: bc2,
                RenderMode: ren,
                Definition: def};
    }
    function readSTLfile(opt){
        var canvas = document.getElementById('cv');
        viewer3d = new JSC3D.Viewer(canvas);
        viewer3d.setParameter('SceneUrl', opt.SceneUrl);
        viewer3d.setParameter('InitRotationX', -80);
        viewer3d.setParameter('InitRotationY', 0);
        viewer3d.setParameter('InitRotationZ', 0);
        viewer3d.setParameter('ModelColor', opt.ModelColor);
        viewer3d.setParameter('BackgroundColor1', opt.BackgroundColor1);
        viewer3d.setParameter('BackgroundColor2', opt.BackgroundColor2);
        viewer3d.setParameter('RenderMode', opt.RenderMode);
        viewer3d.setParameter('Definition', opt.Definition);
        viewer3d.init();
        viewer3d.update();
    }
    function changeOption(strOpt,strValue){
    console.log("change " + strOpt + " to " + strValue);
        viewer3d.setParameter(strOpt, strValue);
        viewer3d.init();
        viewer3d.update();
    }
    function openByUrl(){
        var url = document.getElementById("url").value;
        var opt = getOptions();
        opt.SceneUrl = document.getElementById("url").value;
        readSTLfile(opt);
    }
    function openByPass(){
        var pass = document.getElementById("url").value;
        var opt = getOptions();
        var fs = document.getElementById("pass").files;
        var f = fs[0];
        var reader = new FileReader();
        reader.onload = (function(theFile) {
            return function(e) {            
                opt.SceneUrl = e.target.result;
                console.log(opt.SceneUrl);
                readSTLfile(opt);
            };
        })(f);
        reader.readAsDataURL(f);
    }
    function openByGet(){
        var q = GetQueryString();
        console.log(q);
        var url = '/stl_files/<%= @product.id %>.stl';
        var opt = getOptions();
        opt.SceneUrl = url;
        readSTLfile(opt);
    }
    function GetQueryString(){
        if( 1 < window.location.search.length )
        {
            var query = window.location.search.substring( 1 );
            var parameters = query.split( '&' );
            var result = new Object();
            for( var i = 0; i < parameters.length; i++ )
            {
                var element = parameters[ i ].split( '=' );
                var paramName = decodeURIComponent( element[ 0 ] );
                var paramValue = decodeURIComponent( element[ 1 ] );
                result[ paramName ] = decodeURIComponent( paramValue );
            }
            return result;
        }
        return null;
    }
    window.onload = function(){
        openByGet();
    }
</script>
